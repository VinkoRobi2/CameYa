package emp

import (
	"database/sql"
	"encoding/json"

	"fmt"
	"net/http"
	"strings"
	"github.com/gin-gonic/gin"
)

type UpdateEmpleadorInput struct {
	Telefono               *string   `json:"telefono"`
	Whatsapp               *string   `json:"whatsapp"`

	PreferenciasCategorias *[]string `json:"preferencias_categorias"`
	LinkedIn               *string   `json:"linkedin"`
	FacebookIG             *string   `json:"facebook_ig"`
	OtrosLinks             *string   `json:"otros_links"`
}


// Funci칩n para actualizar los campos permitidos de un empleador
func UpdateEmpleador(ctx *gin.Context, db *sql.DB) {
	userID, err := getUserIdFromJWT(ctx)
	if err != nil {
		ctx.JSON(http.StatusUnauthorized, gin.H{"error": err.Error()})
		return
	}

	var input UpdateEmpleadorInput
	if err := ctx.ShouldBindJSON(&input); err != nil {
		ctx.JSON(http.StatusBadRequest, gin.H{"error": "JSON inv치lido"})
		return
	}

	var setParts []string
	var args []interface{}
	argPos := 1

	if input.Telefono != nil {
		setParts = append(setParts, fmt.Sprintf("telefono=$%d", argPos))
		args = append(args, *input.Telefono)
		argPos++
	}
	if input.Whatsapp != nil {
		setParts = append(setParts, fmt.Sprintf("whatsapp=$%d", argPos))
		args = append(args, *input.Whatsapp)
		argPos++
	}


































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































	          
	if input.PreferenciasCategorias != nil {
		jsonCategorias, _ := json.Marshal(input.PreferenciasCategorias)
		setParts = append(setParts, fmt.Sprintf("preferencias_categorias=$%d", argPos))
		args = append(args, jsonCategorias)
		argPos++
	}
	if input.LinkedIn != nil {
		setParts = append(setParts, fmt.Sprintf("linkedin=$%d", argPos))
		args = append(args, *input.LinkedIn)
		argPos++
	}
	if input.FacebookIG != nil {
		setParts = append(setParts, fmt.Sprintf("facebook_ig=$%d", argPos))
		args = append(args, *input.FacebookIG)
		argPos++
	}
	if input.OtrosLinks != nil {
		setParts = append(setParts, fmt.Sprintf("otros_links=$%d", argPos))
		args = append(args, *input.OtrosLinks)
		argPos++
	}

	if len(setParts) == 0 {
		ctx.JSON(http.StatusBadRequest, gin.H{"error": "No se proporcionaron campos para actualizar"})
		return
	}

	args = append(args, userID)
	query := fmt.Sprintf("UPDATE empleadores SET %s WHERE id=$%d", strings.Join(setParts, ", "), argPos)

	if _, err := db.Exec(query, args...); err != nil {
		ctx.JSON(http.StatusInternalServerError, gin.H{"error": "Error al actualizar la informaci칩n"})
		return
	}

	ctx.JSON(http.StatusOK, gin.H{"message": "Informaci칩n actualizada correctamente"})
}